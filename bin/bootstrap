#! /bin/bash

# -----------------------------------------------------------------------------

set -eu -o pipefail
readonly _BASENAME=$( basename ${BASH_SOURCE[0]} )
readonly _DIRNAME=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && realpath . )
readonly _ROOT=$( dirname ${_DIRNAME} )


# clean -----------------------------------------------------------------------

rm -rf ${_ROOT}/obj
rm -rf ${_ROOT}/log


# tools -----------------------------------------------------------------------

source ${_ROOT}/etc/tools 


# update worktrees ------------------------------------------------------------

#${_DIRNAME}/git-write-worktrees


# bootstrap -------------------------------------------------------------------

${_DIRNAME}/stage1
${_DIRNAME}/stage2
${_DIRNAME}/stage3


# install ---------------------------------------------------------------------

opt_install_dir=/opt/LLVM-${llvm_version}/
stage3_target_dir=${_ROOT}/obj/llvm/llvm-project/${llvm_version}/stage3/target/
rsync --verbose --archive --delete ${stage3_target_dir}/ ${opt_install_dir}/

file --dereference ${opt_install_dir}/bin/clang
${opt_install_dir}/bin/clang -v

ldd ${opt_install_dir}/bin/clang
